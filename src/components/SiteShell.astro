---
import '../styles/global.css';
import { getSiteConfig } from '../lib/site-config';
import ThemeToggle from './ThemeToggle.astro';

interface Props {
  pageTitle?: string;
}

const { pageTitle } = Astro.props;
const config = await getSiteConfig();
const fullTitle = pageTitle ? `${pageTitle} | ${config.blog_title}` : config.blog_title;
const rootStyle = `--accent-hue: ${config.accent_hue}; --container-max: ${config.content_max_width}; --detail-max: ${config.content_max_width};`;
---

<html lang="en" data-theme={config.default_theme} style={rootStyle}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{fullTitle}</title>
    <slot name="head" />
  </head>
  <body>
    <a class="visually-hidden-focusable" href="#main-content">Skip to content</a>
    <header class="topbar">
      <div class="topbar-inner">
        <a href="/" class="brand">{config.blog_title}</a>
        <nav class="nav-links" aria-label="Primary">
          <a href="/posts">Posts</a>
          <a href="/snippets">Snippets</a>
          <a href="/analytics">Analytics</a>
        </nav>
        <ThemeToggle currentTheme={config.default_theme} />
      </div>
    </header>

    <main id="main-content">
      <slot />
    </main>

    <footer class="site-footer">
      <div class="container muted">{config.footer_text}</div>
    </footer>

    <script is:inline>
      (() => {
        const key = 'deelan-theme';
        const root = document.documentElement;
        const toggle = document.getElementById('theme-toggle');

        const stored = localStorage.getItem(key);
        const initial = stored || root.getAttribute('data-theme') || 'light';
        root.setAttribute('data-theme', initial);

        const syncLabel = () => {
          if (!toggle) return;
          const current = root.getAttribute('data-theme') || 'light';
          toggle.setAttribute(
            'aria-label',
            current === 'dark' ? 'Switch to light theme' : 'Switch to dark theme'
          );
          toggle.setAttribute(
            'title',
            current === 'dark' ? 'Switch to light theme' : 'Switch to dark theme'
          );
          toggle.setAttribute('data-theme', current);
        };

        if (toggle) {
          toggle.addEventListener('click', () => {
            const current = root.getAttribute('data-theme') || 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', next);
            localStorage.setItem(key, next);
            syncLabel();
          });
        }

        syncLabel();
      })();
    </script>
    <script is:inline>
      (() => {
        let toastTimer = null;

        function showToast(message) {
          let toast = document.getElementById('copy-toast');
          if (!(toast instanceof HTMLElement)) {
            toast = document.createElement('div');
            toast.id = 'copy-toast';
            toast.className = 'copy-toast';
            document.body.appendChild(toast);
          }
          toast.textContent = message;
          toast.classList.add('is-visible');
          if (toastTimer) window.clearTimeout(toastTimer);
          toastTimer = window.setTimeout(() => toast.classList.remove('is-visible'), 1200);
        }

        document.addEventListener('click', async (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;
          const link = target.closest('[data-copy-link]');
          if (!(link instanceof HTMLAnchorElement || link instanceof HTMLElement)) return;
          event.preventDefault();

          const raw = link.getAttribute('data-copy-url');
          if (!raw) return;
          const absolute = new URL(raw, window.location.origin).toString();
          try {
            await navigator.clipboard.writeText(absolute);
            showToast('Permalink copied.');
          } catch {
            showToast('Could not copy permalink.');
          }
        });
      })();
    </script>
    <script type="module" src="/js/pwa-register.js"></script>
  </body>
</html>
