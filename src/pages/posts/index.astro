---
import SiteShell from '../../components/layout/SiteShell.astro';
import { loadPostsIndex, loadTimeline } from '../../lib/content/generated';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

const posts = await loadPostsIndex();
const timeline = await loadTimeline();
const siteConfig = await getSiteConfig();

function effectiveDate(id: string, fallback: string | null): string | null {
  const item = timeline.items[id];
  return item?.effective_updated_at ?? item?.effective_created_at ?? fallback;
}

function displayDate(value: string | null): string {
  return formatTimestamp(value, siteConfig.timezone);
}
---

<SiteShell pageTitle="Posts">
  <div class="container stack">
    <header class="page-header">
      <span class="eyebrow">Library</span>
      <h1 class="page-title">Posts</h1>
      <p class="page-subtitle">
        <span id="posts-visible-count">{posts.total}</span> / {posts.total} item(s). Indexed at{' '}
        {displayDate(posts.generated_at)}.
      </p>
    </header>

    <section class="search-shell">
      <div class="search-tabs" role="tablist" aria-label="Posts search mode">
        <input id="posts-mode-simple" class="search-mode-input" type="radio" name="posts-search-mode" checked />
        <label for="posts-mode-simple" id="posts-tab-simple" class="search-tab" role="tab" aria-selected="true">
          Simple
        </label>
        <input id="posts-mode-advanced" class="search-mode-input" type="radio" name="posts-search-mode" />
        <label
          for="posts-mode-advanced"
          id="posts-tab-advanced"
          class="search-tab"
          role="tab"
          aria-selected="false"
        >
          Advanced
        </label>
      </div>

      <div class="panel section-block search-panel">
        <div id="posts-search-simple" class="filter-grid">
          <label>
            Tag
            <input id="posts-tag" type="search" placeholder="e.g. data.lake.*" autocomplete="off" />
          </label>
          <label>
            Title
            <input id="posts-title" type="search" placeholder="title contains..." autocomplete="off" />
          </label>
          <label>
            From
            <input id="posts-from" type="date" />
          </label>
          <label>
            To
            <input id="posts-to" type="date" />
          </label>
        </div>

        <div id="posts-search-advanced" hidden style="display: none;">
          <label>
            Query
            <input
              id="posts-query"
              type="search"
              placeholder="Use &, |, (), plus tag:, title:, from:, to:"
              autocomplete="off"
            />
          </label>
        </div>
      </div>
    </section>

    <section class="view-toggle">
      <button id="posts-view-table" type="button" aria-pressed="true" title="Table view" aria-label="Table view">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="5" width="18" height="14" rx="1"></rect>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <line x1="9" y1="5" x2="9" y2="19"></line>
          <line x1="15" y1="5" x2="15" y2="19"></line>
        </svg>
      </button>
      <button id="posts-view-list" type="button" aria-pressed="false" title="List view" aria-label="List view">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <line x1="6" y1="7" x2="21" y2="7"></line>
          <line x1="6" y1="12" x2="21" y2="12"></line>
          <line x1="6" y1="17" x2="21" y2="17"></line>
          <circle cx="3.5" cy="7" r="1.2"></circle>
          <circle cx="3.5" cy="12" r="1.2"></circle>
          <circle cx="3.5" cy="17" r="1.2"></circle>
        </svg>
      </button>
    </section>

    <div id="posts-table-view" class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Updated</th>
            <th>Tags</th>
          </tr>
        </thead>
        <tbody>
          {posts.items.map((post) => (
            <tr
              data-post-item
              data-key={post.id}
              data-text={`${post.title} ${post.summary ?? ''} ${post.content_text}`}
              data-tags={post.tags.join(',')}
              data-title={post.title}
              data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
            >
              <td>
                <a href={`/posts/${post.id}`}>{post.title}</a>
                <div class="muted">{post.id}</div>
              </td>
              <td>{post.status}</td>
              <td>{displayDate(effectiveDate(post.id, post.updated_at ?? post.created_at))}</td>
              <td>
                <div class="tag-cloud">
                  {post.tags.map((tag) => (
                    <span class="tag-pill">
                      {tag.split('.').map((part) => (
                        <span>{part}</span>
                      ))}
                    </span>
                  ))}
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div id="posts-list-view" style="display: none;">
      <ul class="cards">
        {posts.items.map((post) => (
          <li
            class="panel"
            data-post-item
            data-key={post.id}
            data-text={`${post.title} ${post.summary ?? ''} ${post.content_text}`}
            data-tags={post.tags.join(',')}
            data-title={post.title}
            data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
          >
            <h2><a href={`/posts/${post.id}`}>{post.title}</a></h2>
            <p class="muted">{post.id}</p>
            {post.summary ? <p>{post.summary}</p> : null}
            <div class="tag-cloud posts-card-tags">
              {post.tags.map((tag) => (
                <span class="tag-pill">
                  {tag.split('.').map((part) => (
                    <span>{part}</span>
                  ))}
                </span>
              ))}
            </div>
          </li>
        ))}
      </ul>
    </div>
  </div>

  <script type="module">
    import { initFilter, initViewToggle } from '/js/filter.js?v=20260219-1';

    initFilter({
      querySelector: '#posts-query',
      tagSelector: '#posts-tag',
      titleSelector: '#posts-title',
      fromSelector: '#posts-from',
      toSelector: '#posts-to',
      simpleTabSelector: '#posts-tab-simple',
      advancedTabSelector: '#posts-tab-advanced',
      simpleModeSelector: '#posts-mode-simple',
      advancedModeSelector: '#posts-mode-advanced',
      simplePanelSelector: '#posts-search-simple',
      advancedPanelSelector: '#posts-search-advanced',
      itemSelector: '[data-post-item]',
      countSelector: '#posts-visible-count'
    });

    initViewToggle({
      tableButtonSelector: '#posts-view-table',
      listButtonSelector: '#posts-view-list',
      tableSelector: '#posts-table-view',
      listSelector: '#posts-list-view'
    });
  </script>
</SiteShell>
