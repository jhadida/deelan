---
import SiteShell from '../../components/SiteShell.astro';
import SearchShell from '../../components/SearchShell.astro';
import TagCloud from '../../components/TagCloud.astro';
import '../../styles/tailwind-pilot.css';
import { loadPostsIndex, loadTimeline } from '../../lib/content/generated';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

const posts = await loadPostsIndex();
const timeline = await loadTimeline();
const siteConfig = await getSiteConfig();
const enablePostsListView = siteConfig.enable_posts_list_view;
const enableTailwindPilot = siteConfig.enable_tailwind_pilot;

function effectiveDate(id: string, fallback: string | null): string | null {
  const item = timeline.items[id];
  return item?.effective_updated_at ?? item?.effective_created_at ?? fallback;
}

function displayDate(value: string | null): string {
  return formatTimestamp(value, siteConfig.timezone);
}
---

<SiteShell pageTitle="Posts">
  <div
    class:list={[
      'container stack',
      enableTailwindPilot ? 'posts-tailwind-pilot' : null
    ]}
    data-posts-list-view-enabled={enablePostsListView ? 'true' : 'false'}
    data-tailwind-pilot={enableTailwindPilot ? 'true' : 'false'}
  >
    <header class="page-header">
      <span class="eyebrow">Library</span>
      <h1 class="page-title">Posts</h1>
      <p class="page-subtitle">
        <span id="posts-visible-count">{posts.total}</span> / {posts.total} item(s). Indexed at{' '}
        {displayDate(posts.generated_at)}.
      </p>
      {enableTailwindPilot ? <p class="pilot-note">Tailwind pilot styling active</p> : null}
    </header>

    <SearchShell idPrefix="posts" ariaLabel="Posts search mode" />

    {
      enablePostsListView ? (
        <section class="view-toggle">
          <button id="posts-view-table" type="button" aria-pressed="true" title="Table view" aria-label="Table view">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="5" width="18" height="14" rx="1"></rect>
              <line x1="3" y1="10" x2="21" y2="10"></line>
              <line x1="9" y1="5" x2="9" y2="19"></line>
              <line x1="15" y1="5" x2="15" y2="19"></line>
            </svg>
          </button>
          <button id="posts-view-list" type="button" aria-pressed="false" title="List view" aria-label="List view">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="7" x2="21" y2="7"></line>
              <line x1="6" y1="12" x2="21" y2="12"></line>
              <line x1="6" y1="17" x2="21" y2="17"></line>
              <circle cx="3.5" cy="7" r="1.2"></circle>
              <circle cx="3.5" cy="12" r="1.2"></circle>
              <circle cx="3.5" cy="17" r="1.2"></circle>
            </svg>
          </button>
        </section>
      ) : null
    }

    <div id="posts-table-view" class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>
              <button type="button" class="sort-btn" data-sort-key="title" data-sort-direction="none">
                <span>Title</span><span class="sort-arrows" aria-hidden="true"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></span>
              </button>
            </th>
            <th>Status</th>
            <th>
              <button type="button" class="sort-btn" data-sort-key="date" data-sort-direction="none">
                <span>Updated</span><span class="sort-arrows" aria-hidden="true"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></span>
              </button>
            </th>
            <th>Tags</th>
          </tr>
        </thead>
        <tbody>
          {posts.items.map((post) => (
            <tr
              data-post-item
              data-key={post.id}
              data-text={`${post.title} ${post.description ?? ''} ${post.content_text}`}
              data-tags={post.tags.join(',')}
              data-title={post.title}
              data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
            >
              <td>
                <a href={`/view/${post.id}`} target="_blank" rel="noopener noreferrer">{post.title}</a>
                <div class="muted">
                  <a
                    href="#"
                    class="copy-link"
                    data-copy-link
                    data-copy-url={`/view/${post.id}`}
                    title="Copy permalink"
                    >{post.id}</a
                  >
                </div>
              </td>
              <td>{post.status ?? 'published'}</td>
              <td>{displayDate(effectiveDate(post.id, post.updated_at ?? post.created_at))}</td>
              <td>
                <TagCloud tags={post.tags} />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    {
      enablePostsListView ? (
        <div id="posts-list-view" style="display: none;">
          <ul class="cards">
            {posts.items.map((post) => (
              <li
                class="panel"
                data-post-item
                data-key={post.id}
                data-text={`${post.title} ${post.description ?? ''} ${post.content_text}`}
                data-tags={post.tags.join(',')}
                data-title={post.title}
                data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
              >
                <h2><a href={`/view/${post.id}`} target="_blank" rel="noopener noreferrer">{post.title}</a></h2>
                <p class="muted">
                  <a
                    href="#"
                    class="copy-link"
                    data-copy-link
                    data-copy-url={`/view/${post.id}`}
                    title="Copy permalink"
                    >{post.id}</a
                  >
                </p>
                {post.description ? <p>{post.description}</p> : null}
                <TagCloud tags={post.tags} className="posts-card-tags" />
              </li>
            ))}
          </ul>
        </div>
      ) : null
    }
  </div>

  <script type="module">
    import { initFilter, initViewToggle } from '/js/filter.js?v=20260219-1';

    initFilter({
      querySelector: '#posts-query',
      tagSelector: '#posts-tag',
      titleSelector: '#posts-title',
      fromSelector: '#posts-from',
      toSelector: '#posts-to',
      simpleTabSelector: '#posts-tab-simple',
      advancedTabSelector: '#posts-tab-advanced',
      simpleModeSelector: '#posts-mode-simple',
      advancedModeSelector: '#posts-mode-advanced',
      simplePanelSelector: '#posts-search-simple',
      advancedPanelSelector: '#posts-search-advanced',
      itemSelector: '[data-post-item]',
      countSelector: '#posts-visible-count'
    });

    const listViewEnabled =
      document.querySelector('.container[data-posts-list-view-enabled]')?.getAttribute('data-posts-list-view-enabled') === 'true';
    if (listViewEnabled) {
      initViewToggle({
        tableButtonSelector: '#posts-view-table',
        listButtonSelector: '#posts-view-list',
        tableSelector: '#posts-table-view',
        listSelector: '#posts-list-view'
      });
    }

    const tableBody = document.querySelector('#posts-table-view tbody');
    const listRoot = document.querySelector('#posts-list-view .cards');
    const sortButtons = Array.from(document.querySelectorAll('#posts-table-view .sort-btn'));
    let sortKey = 'date';
    let sortDirection = -1;

    function compareDate(aValue, bValue) {
      const a = Date.parse(aValue || '');
      const b = Date.parse(bValue || '');
      if (Number.isNaN(a) && Number.isNaN(b)) return 0;
      if (Number.isNaN(a)) return -1;
      if (Number.isNaN(b)) return 1;
      return a - b;
    }

    function compareByKey(a, b) {
      if (sortKey === 'title') {
        const aTitle = (a.getAttribute('data-title') || '').toLowerCase();
        const bTitle = (b.getAttribute('data-title') || '').toLowerCase();
        return sortDirection * aTitle.localeCompare(bTitle);
      }
      const aDate = a.getAttribute('data-date') || '';
      const bDate = b.getAttribute('data-date') || '';
      return sortDirection * compareDate(aDate, bDate);
    }

    function syncSortIndicators() {
      sortButtons.forEach((button) => {
        const key = button.getAttribute('data-sort-key');
        const direction = key === sortKey ? (sortDirection > 0 ? 'asc' : 'desc') : 'none';
        button.setAttribute('data-sort-direction', direction);
        const th = button.closest('th');
        if (th) {
          th.setAttribute(
            'aria-sort',
            direction === 'asc' ? 'ascending' : direction === 'desc' ? 'descending' : 'none'
          );
        }
      });
    }

    function applySort() {
      const tableRows = Array.from(document.querySelectorAll('#posts-table-view tbody tr[data-post-item]'));
      const listRows = listViewEnabled
        ? Array.from(document.querySelectorAll('#posts-list-view li[data-post-item]'))
        : [];
      const listByKey = listViewEnabled
        ? new Map(listRows.map((row) => [row.getAttribute('data-key'), row]))
        : new Map();
      const sortedTable = [...tableRows].sort(compareByKey);
      const sortedKeys = sortedTable.map((row) => row.getAttribute('data-key'));

      if (tableBody) {
        sortedTable.forEach((row) => tableBody.appendChild(row));
      }
      if (listViewEnabled && listRoot) {
        sortedKeys.forEach((key) => {
          const item = key ? listByKey.get(key) : null;
          if (item) listRoot.appendChild(item);
        });
      }
    }

    sortButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const key = button.getAttribute('data-sort-key');
        if (!key) return;
        if (key === sortKey) sortDirection *= -1;
        else {
          sortKey = key;
          sortDirection = key === 'title' ? 1 : -1;
        }
        syncSortIndicators();
        applySort();
      });
    });

    syncSortIndicators();
    applySort();
  </script>
</SiteShell>
