---
import SiteShell from '../../components/SiteShell.astro';
import SearchShell from '../../components/SearchShell.astro';
import TagCloud from '../../components/TagCloud.astro';
import { loadPostsIndex, loadTimeline } from '../../lib/content/generated';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

const posts = await loadPostsIndex();
const timeline = await loadTimeline();
const siteConfig = await getSiteConfig();

function effectiveDate(id: string, fallback: string | null): string | null {
  const item = timeline.items[id];
  return item?.effective_updated_at ?? item?.effective_created_at ?? fallback;
}

function displayDate(value: string | null): string {
  return formatTimestamp(value, siteConfig.timezone);
}
---

<SiteShell pageTitle="Posts">
  <div class="container stack">
    <header class="page-header">
      <span class="eyebrow">Library</span>
      <h1 class="page-title">Posts</h1>
      <p class="page-subtitle">
        <span id="posts-visible-count">{posts.total}</span> / {posts.total} item(s). Indexed at{' '}
        {displayDate(posts.generated_at)}.
      </p>
    </header>

    <SearchShell idPrefix="posts" ariaLabel="Posts search mode" />

    <section class="view-toggle">
      <button id="posts-view-table" type="button" aria-pressed="true" title="Table view" aria-label="Table view">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="5" width="18" height="14" rx="1"></rect>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <line x1="9" y1="5" x2="9" y2="19"></line>
          <line x1="15" y1="5" x2="15" y2="19"></line>
        </svg>
      </button>
      <button id="posts-view-list" type="button" aria-pressed="false" title="List view" aria-label="List view">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <line x1="6" y1="7" x2="21" y2="7"></line>
          <line x1="6" y1="12" x2="21" y2="12"></line>
          <line x1="6" y1="17" x2="21" y2="17"></line>
          <circle cx="3.5" cy="7" r="1.2"></circle>
          <circle cx="3.5" cy="12" r="1.2"></circle>
          <circle cx="3.5" cy="17" r="1.2"></circle>
        </svg>
      </button>
    </section>

    <div id="posts-table-view" class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Updated</th>
            <th>Tags</th>
          </tr>
        </thead>
        <tbody>
          {posts.items.map((post) => (
            <tr
              data-post-item
              data-key={post.id}
              data-text={`${post.title} ${post.summary ?? ''} ${post.content_text}`}
              data-tags={post.tags.join(',')}
              data-title={post.title}
              data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
            >
              <td>
                <a href={`/posts/${post.id}`}>{post.title}</a>
                <div class="muted">{post.id}</div>
              </td>
              <td>{post.status}</td>
              <td>{displayDate(effectiveDate(post.id, post.updated_at ?? post.created_at))}</td>
              <td>
                <TagCloud tags={post.tags} />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div id="posts-list-view" style="display: none;">
      <ul class="cards">
        {posts.items.map((post) => (
          <li
            class="panel"
            data-post-item
            data-key={post.id}
            data-text={`${post.title} ${post.summary ?? ''} ${post.content_text}`}
            data-tags={post.tags.join(',')}
            data-title={post.title}
            data-date={effectiveDate(post.id, post.updated_at ?? post.created_at) ?? ''}
          >
            <h2><a href={`/posts/${post.id}`}>{post.title}</a></h2>
            <p class="muted">{post.id}</p>
            {post.summary ? <p>{post.summary}</p> : null}
            <TagCloud tags={post.tags} className="posts-card-tags" />
          </li>
        ))}
      </ul>
    </div>
  </div>

  <script type="module">
    import { initFilter, initViewToggle } from '/js/filter.js?v=20260219-1';

    initFilter({
      querySelector: '#posts-query',
      tagSelector: '#posts-tag',
      titleSelector: '#posts-title',
      fromSelector: '#posts-from',
      toSelector: '#posts-to',
      simpleTabSelector: '#posts-tab-simple',
      advancedTabSelector: '#posts-tab-advanced',
      simpleModeSelector: '#posts-mode-simple',
      advancedModeSelector: '#posts-mode-advanced',
      simplePanelSelector: '#posts-search-simple',
      advancedPanelSelector: '#posts-search-advanced',
      itemSelector: '[data-post-item]',
      countSelector: '#posts-visible-count'
    });

    initViewToggle({
      tableButtonSelector: '#posts-view-table',
      listButtonSelector: '#posts-view-list',
      tableSelector: '#posts-table-view',
      listSelector: '#posts-list-view'
    });
  </script>
</SiteShell>
