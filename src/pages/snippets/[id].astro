---
import fs from 'node:fs/promises';
import path from 'node:path';
import matter from 'gray-matter';
import SiteShell from '../../components/SiteShell.astro';
import RelatedList from '../../components/RelatedList.astro';
import {
  loadPostsIndex,
  loadSnippetsIndex,
  loadTimeline,
  type GeneratedIndexItem
} from '../../lib/content/generated';
import { renderMarkdown } from '../../lib/content/render-markdown';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

export async function getStaticPaths() {
  const snippets = await loadSnippetsIndex();
  return snippets.items.map((item) => ({
    params: { id: item.id },
    props: { item }
  }));
}

const { item } = Astro.props as { item: GeneratedIndexItem };
const siteConfig = await getSiteConfig();

const posts = await loadPostsIndex();
const snippets = await loadSnippetsIndex();
const timeline = await loadTimeline();

const postById = new Map(posts.items.map((candidate) => [candidate.id, candidate]));
const snippetById = new Map(snippets.items.map((candidate) => [candidate.id, candidate]));

const relatedItems = item.related_ids
  .map((id) => {
    const snippet = snippetById.get(id);
    if (snippet && snippet.id !== item.id) {
      return { id: snippet.id, title: snippet.title, href: `/snippets/${snippet.id}` };
    }
    const post = postById.get(id);
    if (post) {
      return { id: post.id, title: post.title, href: `/posts/${post.id}` };
    }
    return null;
  })
  .filter((entry): entry is { id: string; title: string; href: string } => !!entry);

const updatedAt = formatTimestamp(
  timeline.items[item.id]?.effective_updated_at ?? item.updated_at ?? item.created_at ?? null,
  siteConfig.timezone
);

const sourcePath = path.join(process.cwd(), item.file_path);
const raw = await fs.readFile(sourcePath, 'utf8');
const parsed = matter(raw);
const renderedHtml = await renderMarkdown(parsed.content);
---

<SiteShell pageTitle={item.title}>
  <Fragment slot="head">
    <script is:inline>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      };
    </script>
    <script defer src="/mathjax/tex-mml-chtml.js"></script>
  </Fragment>

  <div class="container">
    <section class="panel markdown-body section-block snippet-single">
      <span class="eyebrow">Snippet</span>
      <h1 class="page-title">{item.title}</h1>
      <p class="page-subtitle">
        {item.id} â€” Last updated: {updatedAt}
      </p>
      {item.notes ? <p>{item.notes}</p> : null}
      <article set:html={renderedHtml}></article>
      <hr class="section-separator" />
      <h2>Related</h2>
      <RelatedList items={relatedItems} />
    </section>
  </div>
</SiteShell>
