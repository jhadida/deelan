---
import fs from 'node:fs/promises';
import path from 'node:path';
import matter from 'gray-matter';
import SiteShell from '../../components/SiteShell.astro';
import RelatedList from '../../components/RelatedList.astro';
import SearchShell from '../../components/SearchShell.astro';
import TagCloud from '../../components/TagCloud.astro';
import { loadPostsIndex, loadSnippetsIndex, loadTimeline } from '../../lib/content/generated';
import { renderMarkdown } from '../../lib/content/render-markdown';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

const snippets = await loadSnippetsIndex();
const posts = await loadPostsIndex();
const timeline = await loadTimeline();
const siteConfig = await getSiteConfig();
const postsById = new Map(posts.items.map((item) => [item.id, item]));
const snippetsById = new Map(snippets.items.map((item) => [item.id, item]));

function resolveRelatedItems(relatedIds: string[]) {
  return relatedIds
    .map((id) => {
      const snippet = snippetsById.get(id);
      if (snippet && snippet.type === 'snippet') {
        return { id: snippet.id, title: snippet.title, href: `/view/${snippet.id}` };
      }
      const post = postsById.get(id);
      if (post) {
        return { id: post.id, title: post.title, href: `/view/${post.id}` };
      }
      return null;
    })
    .filter((entry): entry is { id: string; title: string; href: string } => !!entry);
}

function resolveSnippetUpdatedAt(snippetId: string, fallback: string | null): string {
  const timelineItem = timeline.items[snippetId];
  return timelineItem?.effective_updated_at ?? fallback ?? '';
}

const snippetDetails = await Promise.all(
  snippets.items.map(async (snippet) => {
    const sourcePath = path.join(process.cwd(), snippet.file_path);
    const raw = await fs.readFile(sourcePath, 'utf8');
    const parsed = matter(raw);
    const html = await renderMarkdown(parsed.content);
    const updatedRaw = resolveSnippetUpdatedAt(snippet.id, snippet.updated_at ?? snippet.created_at ?? null);
    const updated = formatTimestamp(updatedRaw, siteConfig.timezone);
    const meta = `${snippet.id} â€” Last updated: ${updated}`;

    return {
      id: snippet.id,
      title: snippet.title,
      notes: snippet.notes ?? '',
      meta,
      html,
      relatedItems: resolveRelatedItems(snippet.related_ids)
    };
  })
);
---

<SiteShell pageTitle="Snippets">
  <Fragment slot="head">
    <script is:inline>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      };
    </script>
    <script defer src="/mathjax/tex-mml-chtml.js"></script>
  </Fragment>

  <div class="container stack">
    <header class="page-header">
      <span class="eyebrow">Library</span>
      <h1 class="page-title">Snippets</h1>
      <p class="page-subtitle">
        <span id="snippets-visible-count">{snippets.total}</span> / {snippets.total} item(s). Indexed at{' '}
        {formatTimestamp(snippets.generated_at, siteConfig.timezone)}.
      </p>
    </header>

    <SearchShell idPrefix="snippets" ariaLabel="Snippets search mode" tagPlaceholder="e.g. python.pandas.*" />

    <section class="snippet-explorer">
      <aside class="panel snippet-list-panel">
        <ul id="snippet-list" class="snippet-list">
          {snippets.items.map((snippet) => (
            <li
              data-snippet-item
              data-key={snippet.id}
              data-title={snippet.title}
              data-text={`${snippet.title} ${snippet.notes ?? ''} ${snippet.content_text}`}
              data-tags={snippet.tags.join(',')}
              data-date={resolveSnippetUpdatedAt(snippet.id, snippet.updated_at ?? snippet.created_at ?? null)}
            >
              <button type="button" class="snippet-select" data-snippet-key={snippet.id}>
                <span class="snippet-select-title">{snippet.title}</span>
                <TagCloud tags={snippet.tags} />
              </button>
            </li>
          ))}
        </ul>
      </aside>

      <section class="panel snippet-detail-panel">
        <div class="section-block">
          <h2 id="snippet-detail-title">Snippet</h2>
          <p id="snippet-detail-meta" class="page-subtitle"></p>
          <p id="snippet-detail-notes" class="muted"></p>
        </div>
        <div id="snippet-detail-content" class="markdown-body"></div>
        <hr class="section-separator" />
        <div class="section-block">
          <h2>Related</h2>
          <div id="snippet-detail-related"></div>
        </div>
      </section>
    </section>
  </div>
  <div id="snippet-detail-payloads" hidden>
    {snippetDetails.map((detail) => (
      <article
        data-snippet-payload={detail.id}
        data-title={detail.title}
        data-meta={detail.meta}
        data-notes={detail.notes}
      >
        <div data-snippet-html set:html={detail.html}></div>
        <div data-snippet-related>
          <RelatedList items={detail.relatedItems} />
        </div>
      </article>
    ))}
  </div>

  <script type="module">
    import { initFilter, initSnippetExplorer } from '/js/filter.js?v=20260219-1';

    const explorer = initSnippetExplorer({
      listSelector: '#snippet-list',
      detailTitleSelector: '#snippet-detail-title',
      detailMetaSelector: '#snippet-detail-meta',
      detailNotesSelector: '#snippet-detail-notes',
      detailContentSelector: '#snippet-detail-content',
      detailRelatedSelector: '#snippet-detail-related',
      payloadSelector: '#snippet-detail-payloads'
    });

    initFilter({
      querySelector: '#snippets-query',
      tagSelector: '#snippets-tag',
      titleSelector: '#snippets-title',
      fromSelector: '#snippets-from',
      toSelector: '#snippets-to',
      simpleTabSelector: '#snippets-tab-simple',
      advancedTabSelector: '#snippets-tab-advanced',
      simpleModeSelector: '#snippets-mode-simple',
      advancedModeSelector: '#snippets-mode-advanced',
      simplePanelSelector: '#snippets-search-simple',
      advancedPanelSelector: '#snippets-search-advanced',
      itemSelector: '[data-snippet-item]',
      countSelector: '#snippets-visible-count',
      onAfterApply: ({ visibleKeys }) => {
        if (explorer) explorer.ensureVisibleSelection(visibleKeys);
      }
    });
  </script>
</SiteShell>
