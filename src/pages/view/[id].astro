---
import fs from 'node:fs/promises';
import path from 'node:path';
import matter from 'gray-matter';
import SiteShell from '../../components/SiteShell.astro';
import RelatedList from '../../components/RelatedList.astro';
import TimelineItem from '../../components/TimelineItem.astro';
import {
  loadPostsIndex,
  loadSnippetsIndex,
  loadTimeline,
  type GeneratedIndexItem
} from '../../lib/content/generated';
import { renderMarkdown } from '../../lib/content/render-markdown';
import { getSiteConfig } from '../../lib/site-config';
import { formatTimestamp } from '../../lib/time';

export async function getStaticPaths() {
  const posts = await loadPostsIndex();
  const snippets = await loadSnippetsIndex();
  const all = [...posts.items, ...snippets.items];

  return all.map((item) => ({
    params: { id: item.id },
    props: { item }
  }));
}

const { item } = Astro.props as { item: GeneratedIndexItem };
const siteConfig = await getSiteConfig();

const timeline = await loadTimeline();
const posts = await loadPostsIndex();
const snippets = await loadSnippetsIndex();
const itemsById = new Map([...posts.items, ...snippets.items].map((entry) => [entry.id, entry]));

const related = item.related_ids
  .map((id) => itemsById.get(id))
  .filter((entry): entry is GeneratedIndexItem => !!entry)
  .map((entry) => ({ id: entry.id, title: entry.title, href: `/view/${entry.id}` }));

const itemTimeline = timeline.items[item.id];
const updatedAtRaw = itemTimeline?.effective_updated_at ?? item.updated_at ?? item.created_at ?? null;
const updatedAt = formatTimestamp(updatedAtRaw, siteConfig.timezone);
const timelineEntries =
  item.type === 'post'
    ? (itemTimeline?.timeline ?? []).map((entry) => ({
        commit: entry.commit.slice(0, 8),
        date: formatTimestamp(entry.date, siteConfig.timezone),
        message: entry.message,
        author: entry.author,
        commitUrl: buildCommitUrl(siteConfig.timeline_commit_url_template, entry.commit)
      }))
    : [];

const sourcePath = path.join(process.cwd(), item.file_path);
const raw = await fs.readFile(sourcePath, 'utf8');
const parsed = matter(raw);
const renderedHtml = await renderMarkdown(parsed.content);

function buildCommitUrl(template: string, commitSha: string): string | null {
  if (!template || !template.includes('${COMMIT_SHA}')) return null;
  return template.replaceAll('${COMMIT_SHA}', commitSha);
}
---

<SiteShell pageTitle={item.title}>
  <Fragment slot="head">
    <script is:inline>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      };
    </script>
    <script defer src="/mathjax/tex-mml-chtml.js"></script>
  </Fragment>

  <div class="container stack">
    <header class="page-header detail-width">
      <span class="eyebrow">{item.type === 'post' ? 'Post' : 'Snippet'}</span>
      <h1 class="page-title">{item.title}</h1>
      <p class="page-subtitle">
        {
          item.type === 'post'
            ? `${item.id} (${item.status ?? 'published'}) — Version: ${item.version ?? 'N/A'} — Last updated: ${updatedAt}`
            : `${item.id} — Last updated: ${updatedAt}`
        }
      </p>
    </header>

    {item.type === 'post' && item.summary ? <p class="detail-width">{item.summary}</p> : null}
    {item.type === 'snippet' && item.notes ? <p class="detail-width">{item.notes}</p> : null}

    <article
      class={
        item.type === 'post'
          ? 'detail-width markdown-body'
          : 'panel markdown-body section-block detail-width'
      }
      set:html={renderedHtml}
    ></article>

    <hr class="section-separator detail-width" />

    <section class="section-block detail-width">
      <h2>Related</h2>
      <RelatedList items={related} showIds={item.type === 'post'} />
    </section>

    {
      item.type === 'post' ? (
        <section class="section-block detail-width">
          <h2>Timeline</h2>
          {
            timelineEntries.length === 0 ? (
              <p class="muted">No git timeline data yet.</p>
            ) : (
              <>
                <p class="muted">Showing {timelineEntries.length} commit(s), newest first.</p>
                <ul class="timeline-list">
                  {timelineEntries.map((entry) => (
                    <TimelineItem
                      commit={entry.commit}
                      commitUrl={entry.commitUrl ?? undefined}
                      date={entry.date}
                      message={entry.message}
                      author={entry.author}
                    />
                  ))}
                </ul>
              </>
            )
          }
        </section>
      ) : null
    }
  </div>
</SiteShell>
